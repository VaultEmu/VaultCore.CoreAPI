<?xml version="1.0"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <EnableDynamicLoading>true</EnableDynamicLoading>
    </PropertyGroup>
    
    <UsingTask TaskName="VaultCore.BuildTasks.JsonManifestGenerationBuildTask"
               AssemblyFile="$(MSBuildThisFileDirectory)..\build\VaultCore.BuildTaskLib.dll"/>

    <Target Name="CreateCoreJsonManifest" AfterTargets="AfterBuild" >
        <JsonManifestGenerationBuildTask DllPath="$(TargetPath)" ManifestOutputPath="$(IntermediateOutputPath)$(TargetName)_Manifest.json"/>
        <Output TaskParameter="ManifestGenerated" PropertyName="JsonManifestGenBuildTaskManifestGenerated" />
    </Target>
    
    <Target Name="CopyCoreJsonManifestToBuildOutput" Condition="'$(JsonManifestGenBuildTaskManifestGenerated)' == 'true'" AfterTargets="CreateCoreJsonManifest" >
        <ItemGroup>
            <GeneratedManifests Include="$(IntermediateOutputPath)$(TargetName)_Manifest.json"/>
        </ItemGroup>
        <Copy SourceFiles="@(GeneratedManifests)" DestinationFolder="$(OutDir)" />
    </Target>

    <Target Name="CopyCoreJsonManifestToPublishOutput" Condition="'$(JsonManifestGenBuildTaskManifestGenerated)' == 'true'" AfterTargets="Publish;CreateCoreJsonManifest" >
        <ItemGroup>
            <GeneratedManifests Include="$(IntermediateOutputPath)$(TargetName)_Manifest.json"/>
        </ItemGroup>
        <Copy SourceFiles="@(GeneratedManifests)" DestinationFolder="$(PublishDir)" />
    </Target>
</Project>